// Global nextflow configuration file for 'umi-amplicon'
// This file configures the core Nextflow options which can be overridden in a pipeline-specific configuration file

// Manifest
manifest {
    name            = 'umi-amplicon'
    author          = 'AI Development Team'
    homePage        = 'https://github.com/umi-amplicon'
    description     = 'umi-amplicon: UMI-tagged amplicon sequencing analysis pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}

// Load base.config by default for all processes
includeConfig 'conf/base.config'

// Load platform-aware configuration (temporarily disabled)
// includeConfig 'conf/platform.config'

// Load nf-core custom profiles from different Institutions
try {
    includeConfig 'conf/custom.config'
} catch (Exception e) {
}

// Load modules.config for DSL2 module specific options
includeConfig 'conf/modules.config'

// Load UMI-tools specific configuration
includeConfig 'conf/modules/umitools.config'

// Load FASTP specific configuration
includeConfig 'conf/modules/fastp.config'

// Load alignment and statistics modules configuration
includeConfig 'conf/modules/alignment.config'

// Load nf-core/config profiles - Docker and Conda support
profiles {
    debug { 
        process.beforeScript = 'echo $HOSTNAME'
    }
    docker {
        docker.enabled = true
    }
    conda {
        // Conda configuration
        includeConfig 'conf/conda_minimal.config'
    }
    mac {
        // macOS configuration (Intel and Apple Silicon)
        conda.enabled = true
        params.skip_mosdepth = true  // mosdepth has conda issues on macOS
    }
    arm64 {
        // ARM64 (Apple Silicon) configuration
        includeConfig 'conf/arm64.config'
    }
    test_minimal {
        // Minimal test configuration
        includeConfig 'conf/test_minimal.config'
    }
    test      { includeConfig 'conf/test.config'      }
    test_full { includeConfig 'conf/test_full.config' }
}

// Load igenomes.config if required
if (!params.igenomes_ignore) {
    includeConfig 'conf/igenomes.config'
} else {
    params.genomes = [:]
}

// Default UMI parameters
params {
    // Help and version
    help = false
    version = false
    
    // Input/Output
    input = null
    outdir = './results'
    fasta = null
    bwa_index = null
    gtf = null
    
    // UMI parameters
    umi_length = 12
    umi_pattern = 'NNNNNNNNNNNN'
    umi_method = 'directional'
    umi_quality_filter_threshold = 15
    umi_collision_rate_threshold = 0.1
    umi_diversity_threshold = 1000
    group_strategy = 'paired'
    consensus_strategy = 'paired'
    min_reads = 1
    min_fraction = 0.5
    error_rate_pre_umi = 0.01
    max_edit_distance = 1
    min_base_quality = 20
    
    // Skip parameters (kept for system/environment checks only)
    skip_mosdepth = false  // Skip mosdepth coverage calculation (may have conda issues on macOS)
    
    // Read processing parameters
    merge_pairs = true  // Merge R1+R2 into single-end reads (recommended for amplicons)
                        // Set to false to keep paired-end for downstream analysis
    treat_as_single = false  // If true, treat filtered R1 and R2 as independent single-end reads
                             // Useful when you want both reads but analyzed separately
    
    // FASTP parameters
    fastp_save_trimmed_fail = false
    fastp_save_merged = true
    fastp_qualified_quality = 20
    fastp_cut_mean_quality = 20
    fastp_adapter_fasta = null
    
    // Output parameters
    publish_dir_mode = 'copy'
    
    // Resource limits
    max_cpus = 8
    max_memory = '24.GB'
    max_time = '240.h'
}

// Export these variables to prevent local Python/R libraries from conflicting with those in the container
// The JULIA_* variables are used by Julia packages
env {
    PYTHONNOUSERSITE = 1
    R_LIBS_USER = ''
    JULIA_DEPOT_PATH = ''
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Timeline, report, trace, and DAG configuration is handled in conf/base.config

